


<!DOCTYPE html>
<html lang="en" class="">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# object: http://ogp.me/ns/object# article: http://ogp.me/ns/article# profile: http://ogp.me/ns/profile#">
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="width=1020">
    
    
    <title>DataMatrixWriter generates wrong BitMatrix · Issue #300 · zxing/zxing · GitHub</title>
    <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="GitHub">
    <link rel="fluid-icon" href="https://github.com/fluidicon.png" title="GitHub">
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-144.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144.png">
    <meta property="fb:app_id" content="1401488693436528">

      <meta content="@github" name="twitter:site" /><meta content="summary" name="twitter:card" /><meta content="DataMatrixWriter generates wrong BitMatrix · Issue #300 · zxing/zxing" name="twitter:title" /><meta content="When trying to encode the string &quot;DTCP01&quot; (without quotes), the DataMatrixWriter delivers a wrong BitMatrix. The BitMatrix represents the string &quot;DTCP04 47&quot; (without quotes).

The issue is easy to ..." name="twitter:description" /><meta content="https://avatars0.githubusercontent.com/u/10759673?v=3&amp;s=400" name="twitter:image:src" />
      <meta content="GitHub" property="og:site_name" /><meta content="object" property="og:type" /><meta content="https://avatars0.githubusercontent.com/u/10759673?v=3&amp;s=400" property="og:image" /><meta content="DataMatrixWriter generates wrong BitMatrix · Issue #300 · zxing/zxing" property="og:title" /><meta content="https://github.com/zxing/zxing/issues/300" property="og:url" /><meta content="When trying to encode the string &quot;DTCP01&quot; (without quotes), the DataMatrixWriter delivers a wrong BitMatrix. The BitMatrix represents the string &quot;DTCP04 47&quot; (without quotes).

The issue is easy to ..." property="og:description" />
      <meta name="browser-stats-url" content="https://api.github.com/_private/browser/stats">
    <meta name="browser-errors-url" content="https://api.github.com/_private/browser/errors">
    <link rel="assets" href="https://assets-cdn.github.com/">
    
    <meta name="pjax-timeout" content="1000">
    

    <meta name="msapplication-TileImage" content="/windows-tile.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="selected-link" value="repo_issues" data-pjax-transient>

        <meta name="google-analytics" content="UA-3769691-2">

    <meta content="collector.githubapp.com" name="octolytics-host" /><meta content="collector-cdn.github.com" name="octolytics-script-host" /><meta content="github" name="octolytics-app-id" /><meta content="9E84FF69:5D11:EF8AA0:55DB59FF" name="octolytics-dimension-request_id" />
    
    <meta content="Rails, view, issues#show" data-pjax-transient="true" name="analytics-event" />
    <meta class="js-ga-set" name="dimension1" content="Logged Out">
      <meta class="js-ga-set" name="dimension4" content="Current repo nav">
    <meta name="is-dotcom" content="true">
        <meta name="hostname" content="github.com">
    <meta name="user-login" content="">

      <link rel="icon" sizes="any" mask href="https://assets-cdn.github.com/pinned-octocat.svg">
      <meta name="theme-color" content="#4078c0">
      <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">

    <!-- </textarea> --><!-- '"` --><meta content="authenticity_token" name="csrf-param" />
<meta content="bs12ZfNdNowSWHzl5LtEbzD/mZRzLBXvuS63xxh8J+MMREsRqsoZV3Q3lLovqTsyFx5Vu1ZhnxSaCiBnWIXp9g==" name="csrf-token" />
    

    <link crossorigin="anonymous" href="https://assets-cdn.github.com/assets/github/index-17ad0ea72cb80a46ba6d1bd6e3c69789acb0e1c0cae43beb90477759cce1bdfd.css" media="all" rel="stylesheet" />
    <link crossorigin="anonymous" href="https://assets-cdn.github.com/assets/github2/index-9f11074052a3551cd7bae2fba8b949844d2d7329927a7f1cb5a2c2a821f016e0.css" media="all" rel="stylesheet" />
    
    


    <meta http-equiv="x-pjax-version" content="22e6cb7d309429ee0eaff86792eaf1c3">

      
  <meta name="description" content="zxing - Official ZXing (&quot;Zebra Crossing&quot;) project home">
  <meta name="go-import" content="github.com/zxing/zxing git https://github.com/zxing/zxing.git">

  <meta content="1122572" name="octolytics-dimension-user_id" /><meta content="zxing" name="octolytics-dimension-user_login" /><meta content="2562751" name="octolytics-dimension-repository_id" /><meta content="zxing/zxing" name="octolytics-dimension-repository_nwo" /><meta content="true" name="octolytics-dimension-repository_public" /><meta content="false" name="octolytics-dimension-repository_is_fork" /><meta content="2562751" name="octolytics-dimension-repository_network_root_id" /><meta content="zxing/zxing" name="octolytics-dimension-repository_network_root_nwo" />
  <link href="https://github.com/zxing/zxing/commits/master.atom" rel="alternate" title="Recent Commits to zxing:master" type="application/atom+xml">

  </head>


  <body class="logged_out  env-production  vis-public">
    <a href="#start-of-content" tabindex="1" class="accessibility-aid js-skip-to-content">Skip to content</a>
    <div class="wrapper">
      
      
      



        
        <div class="header header-logged-out" role="banner">
  <div class="container clearfix">

    <a class="header-logo-wordmark" href="https://github.com/" data-ga-click="(Logged out) Header, go to homepage, icon:logo-wordmark">
      <span class="mega-octicon octicon-logo-github"></span>
    </a>

    <div class="header-actions" role="navigation">
        <a class="btn btn-primary" href="/join" data-ga-click="(Logged out) Header, clicked Sign up, text:sign-up">Sign up</a>
      <a class="btn" href="/login?return_to=%2Fzxing%2Fzxing%2Fissues%2F300" data-ga-click="(Logged out) Header, clicked Sign in, text:sign-in">Sign in</a>
    </div>

    <div class="site-search repo-scope js-site-search" role="search">
      <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/zxing/zxing/search" class="js-site-search-form" data-global-search-url="/search" data-repo-search-url="/zxing/zxing/search" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /></div>
  <label class="js-chromeless-input-container form-control">
    <div class="scope-badge">This repository</div>
    <input type="text"
      class="js-site-search-focus js-site-search-field is-clearable chromeless-input"
      data-hotkey="s"
      name="q"
      placeholder="Search"
      aria-label="Search this repository"
      data-global-scope-placeholder="Search GitHub"
      data-repo-scope-placeholder="Search"
      tabindex="1"
      autocapitalize="off">
  </label>
</form>
    </div>

      <ul class="header-nav left" role="navigation">
          <li class="header-nav-item">
            <a class="header-nav-link" href="/explore" data-ga-click="(Logged out) Header, go to explore, text:explore">Explore</a>
          </li>
          <li class="header-nav-item">
            <a class="header-nav-link" href="/features" data-ga-click="(Logged out) Header, go to features, text:features">Features</a>
          </li>
          <li class="header-nav-item">
            <a class="header-nav-link" href="https://enterprise.github.com/" data-ga-click="(Logged out) Header, go to enterprise, text:enterprise">Enterprise</a>
          </li>
          <li class="header-nav-item">
            <a class="header-nav-link" href="/pricing" data-ga-click="(Logged out) Header, go to pricing, text:pricing">Pricing</a>
          </li>
      </ul>

  </div>
</div>



      <div id="start-of-content" class="accessibility-aid"></div>
          <div class="site" itemscope itemtype="http://schema.org/WebPage">
    <div id="js-flash-container">
      
    </div>
    <div class="pagehead repohead instapaper_ignore readability-menu">
      <div class="container">

        <div class="clearfix">
          
<ul class="pagehead-actions">

  <li>
      <a href="/login?return_to=%2Fzxing%2Fzxing"
    class="btn btn-sm btn-with-count tooltipped tooltipped-n"
    aria-label="You must be signed in to watch a repository" rel="nofollow">
    <span class="octicon octicon-eye"></span>
    Watch
  </a>
  <a class="social-count" href="/zxing/zxing/watchers">
    789
  </a>

  </li>

  <li>
      <a href="/login?return_to=%2Fzxing%2Fzxing"
    class="btn btn-sm btn-with-count tooltipped tooltipped-n"
    aria-label="You must be signed in to star a repository" rel="nofollow">
    <span class="octicon octicon-star"></span>
    Star
  </a>

    <a class="social-count js-social-count" href="/zxing/zxing/stargazers">
      5,886
    </a>

  </li>

    <li>
      <a href="/login?return_to=%2Fzxing%2Fzxing"
        class="btn btn-sm btn-with-count tooltipped tooltipped-n"
        aria-label="You must be signed in to fork a repository" rel="nofollow">
        <span class="octicon octicon-repo-forked"></span>
        Fork
      </a>
      <a href="/zxing/zxing/network" class="social-count">
        3,739
      </a>
    </li>
</ul>

          <h1 itemscope itemtype="http://data-vocabulary.org/Breadcrumb" class="entry-title public ">
  <span class="mega-octicon octicon-repo"></span>
  <span class="author"><a href="/zxing" class="url fn" itemprop="url" rel="author"><span itemprop="title">zxing</span></a></span><!--
--><span class="path-divider">/</span><!--
--><strong><a href="/zxing/zxing" data-pjax="#js-repo-pjax-container">zxing</a></strong>

  <span class="page-context-loader">
    <img alt="" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
  </span>

</h1>
        
        </div>
      </div>
    </div>

    <div class="container">
      <div class="repository-with-sidebar repo-container new-discussion-timeline ">
        <div class="repository-sidebar clearfix">
          
<nav class="sunken-menu repo-nav js-repo-nav js-sidenav-container-pjax js-octicon-loaders"
     role="navigation"
     data-pjax="#js-repo-pjax-container"
     data-issue-count-url="/zxing/zxing/issues/counts">
  <ul class="sunken-menu-group">
    <li class="tooltipped tooltipped-w" aria-label="Code">
      <a href="/zxing/zxing" aria-label="Code" class="js-selected-navigation-item sunken-menu-item" data-hotkey="g c" data-selected-links="repo_source repo_downloads repo_commits repo_releases repo_tags repo_branches /zxing/zxing">
        <span class="octicon octicon-code"></span> <span class="full-word">Code</span>
        <img alt="" class="mini-loader" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
</a>    </li>

      <li class="tooltipped tooltipped-w" aria-label="Issues">
        <a href="/zxing/zxing/issues" aria-label="Issues" aria-selected="true" class="js-selected-navigation-item selected sunken-menu-item" data-hotkey="g i" data-selected-links="repo_issues repo_labels repo_milestones /zxing/zxing/issues">
          <span class="octicon octicon-issue-opened"></span> <span class="full-word">Issues</span>
          <span class="js-issue-replace-counter"></span>
          <img alt="" class="mini-loader" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
</a>      </li>

    <li class="tooltipped tooltipped-w" aria-label="Pull requests">
      <a href="/zxing/zxing/pulls" aria-label="Pull requests" class="js-selected-navigation-item sunken-menu-item" data-hotkey="g p" data-selected-links="repo_pulls /zxing/zxing/pulls">
          <span class="octicon octicon-git-pull-request"></span> <span class="full-word">Pull requests</span>
          <span class="js-pull-replace-counter"></span>
          <img alt="" class="mini-loader" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
</a>    </li>

      <li class="tooltipped tooltipped-w" aria-label="Wiki">
        <a href="/zxing/zxing/wiki" aria-label="Wiki" class="js-selected-navigation-item sunken-menu-item" data-hotkey="g w" data-selected-links="repo_wiki /zxing/zxing/wiki">
          <span class="octicon octicon-book"></span> <span class="full-word">Wiki</span>
          <img alt="" class="mini-loader" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
</a>      </li>
  </ul>
  <div class="sunken-menu-separator"></div>
  <ul class="sunken-menu-group">

    <li class="tooltipped tooltipped-w" aria-label="Pulse">
      <a href="/zxing/zxing/pulse" aria-label="Pulse" class="js-selected-navigation-item sunken-menu-item" data-selected-links="pulse /zxing/zxing/pulse">
        <span class="octicon octicon-pulse"></span> <span class="full-word">Pulse</span>
        <img alt="" class="mini-loader" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
</a>    </li>

    <li class="tooltipped tooltipped-w" aria-label="Graphs">
      <a href="/zxing/zxing/graphs" aria-label="Graphs" class="js-selected-navigation-item sunken-menu-item" data-selected-links="repo_graphs repo_contributors /zxing/zxing/graphs">
        <span class="octicon octicon-graph"></span> <span class="full-word">Graphs</span>
        <img alt="" class="mini-loader" height="16" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-32.gif" width="16" />
</a>    </li>
  </ul>


</nav>

            <div class="only-with-full-nav">
                
<div class="js-clone-url clone-url open"
  data-protocol-type="http">
  <h3><span class="text-emphasized">HTTPS</span> clone URL</h3>
  <div class="input-group js-zeroclipboard-container">
    <input type="text" class="input-mini input-monospace js-url-field js-zeroclipboard-target"
           value="https://github.com/zxing/zxing.git" readonly="readonly" aria-label="HTTPS clone URL">
    <span class="input-group-button">
      <button aria-label="Copy to clipboard" class="js-zeroclipboard btn btn-sm zeroclipboard-button tooltipped tooltipped-s" data-copied-hint="Copied!" type="button"><span class="octicon octicon-clippy"></span></button>
    </span>
  </div>
</div>

  
<div class="js-clone-url clone-url "
  data-protocol-type="subversion">
  <h3><span class="text-emphasized">Subversion</span> checkout URL</h3>
  <div class="input-group js-zeroclipboard-container">
    <input type="text" class="input-mini input-monospace js-url-field js-zeroclipboard-target"
           value="https://github.com/zxing/zxing" readonly="readonly" aria-label="Subversion checkout URL">
    <span class="input-group-button">
      <button aria-label="Copy to clipboard" class="js-zeroclipboard btn btn-sm zeroclipboard-button tooltipped tooltipped-s" data-copied-hint="Copied!" type="button"><span class="octicon octicon-clippy"></span></button>
    </span>
  </div>
</div>



  <div class="clone-options">You can clone with
    <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/users/set_protocol?protocol_selector=http&amp;protocol_type=clone" class="inline-form js-clone-selector-form " data-form-nonce="0e24cd91ca95243948aa505cd5676d915eb1405e" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="authenticity_token" type="hidden" value="vh3Z/+PlP+FM1lCXp/xwiwlUiR59D7I/NPeziU8EaRWEYcXjtomFqROMmSI9GT97IhBcuOFxK91MSjyErmJVNg==" /></div><button class="btn-link js-clone-selector" data-protocol="http" type="submit">HTTPS</button></form> or <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/users/set_protocol?protocol_selector=subversion&amp;protocol_type=clone" class="inline-form js-clone-selector-form " data-form-nonce="0e24cd91ca95243948aa505cd5676d915eb1405e" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="authenticity_token" type="hidden" value="mEt83pEsikOkkAGzOK/jGyd2qIle/MLF+e4jLD4W7GMKFqQpZ+WM3YrHEqYALxFs6cL8qWeQbZv98uF09GzJNQ==" /></div><button class="btn-link js-clone-selector" data-protocol="subversion" type="submit">Subversion</button></form>.
    <a href="https://help.github.com/articles/which-remote-url-should-i-use" class="help tooltipped tooltipped-n" aria-label="Get help on which URL is right for you.">
      <span class="octicon octicon-question"></span>
    </a>
  </div>

              <a href="/zxing/zxing/archive/master.zip"
                 class="btn btn-sm sidebar-button"
                 aria-label="Download the contents of zxing/zxing as a zip file"
                 title="Download the contents of zxing/zxing as a zip file"
                 rel="nofollow">
                <span class="octicon octicon-cloud-download"></span>
                Download ZIP
              </a>
            </div>
        </div>
        <div id="js-repo-pjax-container" class="repository-content context-loader-container" data-pjax-container>

          
<style type="text/css" media="screen">
  span.labelstyle-009800, .linked-labelstyle-009800 {  background-color: #009800 !important;  color: #fff !important;}.labelstyle-009800.selected {  background-color: #009800 !important;  color: #fff !important;}.label-select-menu .labelstyle-009800.selected {  background:rgba(0, 152, 0, 0.12) !important;  color: #009900 !important;}

span.labelstyle-e11d21, .linked-labelstyle-e11d21 {  background-color: #e11d21 !important;  color: #fff !important;}.labelstyle-e11d21.selected {  background-color: #e11d21 !important;  color: #fff !important;}.label-select-menu .labelstyle-e11d21.selected {  background:rgba(225, 29, 33, 0.12) !important;  color: #991316 !important;}

span.labelstyle-c7def8, .linked-labelstyle-c7def8 {  background-color: #c7def8 !important;  color: #282d33 !important;}.labelstyle-c7def8.selected {  background-color: #c7def8 !important;  color: #282d33 !important;}.label-select-menu .labelstyle-c7def8.selected {  background:rgba(199, 222, 248, 0.12) !important;  color: #7a8898 !important;}
</style>

<div class="issues-listing" data-pjax>
  <div class="context-loader large-format-loader">
  <p><img alt="" height="64" src="https://assets-cdn.github.com/images/spinners/octocat-spinner-128.gif" width="64" /></p>
  <p>Loading…</p>
</div>

    <div id="show_issue" class="js-issues-results">

    
  <div
    id="partial-discussion-header"
    class="gh-header js-details-container js-socket-channel js-updatable-content issue"
    data-channel="zxing/zxing:issue:55914117"
    data-url="/zxing/zxing/issues/300/show_partial?partial=issues%2Ftitle">

  <div class="gh-header-show ">
      <div class="gh-header-actions">
          <a href="/zxing/zxing/issues/new" class="btn btn-sm btn-primary right" data-hotkey="c">
            New issue
          </a>
      </div>

    <h1 class="gh-header-title">
      <span class="js-issue-title">DataMatrixWriter generates wrong BitMatrix</span>
      <span class="gh-header-number">#300</span>
    </h1>
  </div>


  <div class="flex-table gh-header-meta">
    <div class="flex-table-item">
        <div class="state state-closed">
          <span class="octicon octicon-issue-closed"></span>
          Closed
        </div>
    </div>
    <div class="flex-table-item flex-table-item-primary">
        <a href="/HeikoOtt" class="author">HeikoOtt</a> opened this <span class="noun">Issue</span> <time datetime="2015-01-29T15:36:41Z" is="relative-time">Jan 29, 2015</time>
        &middot; 21 comments
    </div>
  </div>
</div>


    <div id="discussion_bucket" class="tab-content clearfix">
      <div class="discussion-sidebar ">
        <div id="partial-discussion-stats"
     class="discussion-stats js-socket-channel js-updatable-content"
     data-channel="zxing/zxing:issue:55914117"
     data-url="/zxing/zxing/issues/300/show_partial?partial=issues%2Fdiscussion_stats">
</div>

<div class="discussion-sidebar-item sidebar-labels js-discussion-sidebar-item">
  <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/zxing/zxing/issues/300?partial=issues%2Fsidebar%2Fshow%2Flabels" class="js-issue-sidebar-form" data-form-nonce="0e24cd91ca95243948aa505cd5676d915eb1405e" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="_method" type="hidden" value="put" /><input name="authenticity_token" type="hidden" value="UdNiGD7K9/qRuc3MOwWVzzi1MkBq5NgtotWUS7/ac18h1oOYkgBhwqNU7rp7xkuP4PFLsFxoYl7Rv+9UUJfLIA==" /></div>
      
  <h3 class="discussion-sidebar-heading">
    Labels
  </h3>


    <div class="labels css-truncate">
    None yet
</div>

</form></div>

<div class="discussion-sidebar-item sidebar-milestone js-discussion-sidebar-item">
  <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/zxing/zxing/issues/300/set_milestone?partial=issues%2Fsidebar%2Fshow%2Fmilestone" class="js-issue-sidebar-form" data-form-nonce="0e24cd91ca95243948aa505cd5676d915eb1405e" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="_method" type="hidden" value="put" /><input name="authenticity_token" type="hidden" value="1bIloSan/KCkQ0Ar1Rmsh2DhOGD3KDzgdsr6UUk1SQ4Qhr+9PlsZRSgGjmcqG7l8WftaaB6bgkKOFz7fukZKzw==" /></div>
    
  <h3 class="discussion-sidebar-heading">
    Milestone
  </h3>


      No milestone

</form></div>

<div class="discussion-sidebar-item sidebar-assignee js-discussion-sidebar-item">
  <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/zxing/zxing/issues/300?partial=issues%2Fsidebar%2Fshow%2Fassignee" class="js-issue-sidebar-form" data-form-nonce="0e24cd91ca95243948aa505cd5676d915eb1405e" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="_method" type="hidden" value="put" /><input name="authenticity_token" type="hidden" value="Mu9j5OMrXYu1TOf1OOZ6rAICDemZKvEuaFv/MUbLVrnsu+VKtEkBaxFt7UE7YnISMyjTkw+mrLwQCrfZH+yn2g==" /></div>
    
  <h3 class="discussion-sidebar-heading">
    Assignee
  </h3>


    <span class="css-truncate">
      No one assigned
</span>

</form></div>


<div id="partial-users-participants" class="discussion-sidebar-item js-socket-channel js-updatable-content"
    data-channel="zxing/zxing:issue:55914117"
      data-url="/zxing/zxing/issues/300/show_partial?partial=issues%2Fparticipants"
  >
  <div class="participation">

    <h3 class="discussion-sidebar-heading">
      3 participants
    </h3>
    <div class="participation-avatars">
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="HeikoOtt" href="/HeikoOtt"><img alt="@HeikoOtt" class="avatar" height="20" src="https://avatars2.githubusercontent.com/u/10759673?v=3&amp;s=40" width="20" /> </a>
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="srowen" href="/srowen"><img alt="@srowen" class="avatar" height="20" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=40" width="20" /> </a>
        <a class="participant-avatar tooltipped tooltipped-s" aria-label="micjahn" href="/micjahn"><img alt="@micjahn" class="avatar" height="20" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=40" width="20" /> </a>
    </div>
  </div>
</div>




      </div>

      <div class="discussion-timeline js-quote-selection-container">

        <div class="js-discussion js-socket-channel" data-channel="zxing/zxing:marked-as-read:55914117">
          

  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/HeikoOtt"><img alt="@HeikoOtt" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/10759673?v=3&amp;s=96" width="48" /></a>
    <div id="issue-55914117"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="531d5a4539dc0bf568d92ab6ba631fe5">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/HeikoOtt" class="author">HeikoOtt</a>
    </strong>

    commented

    <a href="#issue-55914117" class="timestamp">
      <time datetime="2015-01-29T15:36:41Z" is="relative-time">Jan 29, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>When trying to encode the string "<em>DTCP01" (without quotes), the DataMatrixWriter delivers a wrong BitMatrix. The BitMatrix represents the string "</em>DTCP04 47" (without quotes).</p>

<p>The issue is easy to reproduce with the given string. Other examples work.</p>

<p>This is actually a very annoying issue, since the reason for the behavior is not clear. Seems to be somehow related to the leading asterix.</p>

<p>Remark:<br>
Barcode4j has the same issue. IText's BarcodeDatamatrix renders the barcode as expected.<br>
As far as I understood the zxing package history, the DataMatrix implementation is based on Barcode4j - so maybe this is an inherited issue.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/HeikoOtt"><img alt="@HeikoOtt" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/10759673?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72046982"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="6c01205b26060fcca886124b2c51a5b3">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/HeikoOtt" class="author">HeikoOtt</a>
    </strong>

    commented

    <a href="#issuecomment-72046982" class="timestamp">
      <time datetime="2015-01-29T15:47:10Z" is="relative-time">Jan 29, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Simplified test:</p>

<pre><code>    DataMatrixWriter dmw = new DataMatrixWriter();
    BitMatrix b = dmw.encode("*DTCP01", BarcodeFormat.DATA_MATRIX, 64, 64);
    BufferedImage bi = MatrixToImageWriter.toBufferedImage(b);
</code></pre>
      </div>
    </div>

  </div>
</div>

  </div>
  


      


  <div class="discussion-item discussion-item-closed">
    <div class="discussion-item-header" id="event-226906676">

      <span class="octicon octicon-circle-slash discussion-item-icon"></span>
      <img alt="@HeikoOtt" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/10759673?v=3&amp;s=32" width="16" />
      <a href="/HeikoOtt" class="author">HeikoOtt</a>
      closed this   <a href="https://github.com/zxing/zxing/issues/300#event-226906676" class="timestamp"><time class="timestamp" datetime="2015-01-29T15:47:10Z" is="relative-time">Jan 29, 2015</time></a>
    </div>
  </div>

  <div class="closed-banner"></div>




      


  <div class="discussion-item discussion-item-reopened">
    <div class="discussion-item-header" id="event-226906768">

      <span class="octicon octicon-primitive-dot discussion-item-icon"></span>
      <img alt="@HeikoOtt" class="avatar" height="16" src="https://avatars1.githubusercontent.com/u/10759673?v=3&amp;s=32" width="16" />
      <a href="/HeikoOtt" class="author">HeikoOtt</a>
      reopened this   <a href="https://github.com/zxing/zxing/issues/300#event-226906768" class="timestamp"><time class="timestamp" datetime="2015-01-29T15:47:18Z" is="relative-time">Jan 29, 2015</time></a>
    </div>
  </div>



  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/HeikoOtt"><img alt="@HeikoOtt" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/10759673?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72047086"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="3fb32045f259c08f45e3f0a5ef85467f">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/HeikoOtt" class="author">HeikoOtt</a>
    </strong>

    commented

    <a href="#issuecomment-72047086" class="timestamp">
      <time datetime="2015-01-29T15:47:45Z" is="relative-time">Jan 29, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>accidentally closed - sorry</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72048022"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="6388a160581e46137c07d3021c3cb7ad">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-72048022" class="timestamp">
      <time datetime="2015-01-29T15:52:21Z" is="relative-time">Jan 29, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I tried this with the latest code in <code>master</code>, using <code>CommandLineEncoder</code> and <code>CommandLineRunner</code>, and got the expected <code>*DTCP01</code> out. I think a few issues have been fixed in DM over the past few months, so I would try this again with the latest code to see if that works.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72112050"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="642cd7798f197d98ea8fa97fec709c7c">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-72112050" class="timestamp">
      <time datetime="2015-01-29T21:54:24Z" is="relative-time">Jan 29, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I can reproduce it with a min and max size of 10.<br>
 --width=10 --height=10 ...<br>
In that case the X12_UNLATCH isn't added in the X12Encoder.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/HeikoOtt"><img alt="@HeikoOtt" class="timeline-comment-avatar" height="48" src="https://avatars2.githubusercontent.com/u/10759673?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72167716"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="b96a09a5b27fb01f1a163b54c86a8076">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/HeikoOtt" class="author">HeikoOtt</a>
    </strong>

    commented

    <a href="#issuecomment-72167716" class="timestamp">
      <time datetime="2015-01-30T08:14:42Z" is="relative-time">Jan 30, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Thanks for the prompt feedback to both of you! I used the latest code and can confirm both observations. The issue is gone when I use my example above. I still have the issue when using 0,0 or 10, 10 as micjahn described.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72201535"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="0e9d0a1ae2c2d93cf4f9b21743821775">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-72201535" class="timestamp">
      <time datetime="2015-01-30T13:39:23Z" is="relative-time">Jan 30, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>A-ha, yes I see that. The result is then <code>*DTCP04 47</code>. <a href="https://github.com/micjahn" class="user-mention">@micjahn</a> have you narrowed it down enough to propose a fix? I usually don't know the formats well enough at this level to fix these things, but, here it might be clear enough once I step through.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72202793"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="d0176e5e242bc736e0bbcdf165ab0749">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-72202793" class="timestamp">
      <time datetime="2015-01-30T13:49:44Z" is="relative-time">Jan 30, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Hm, in this case, the given dimension is so small that only 5 codewords can be encoded. After encoding 6 of the 7 characters, all 5 are used up. The code doesn't write the unlatch, but a comment in the code says it's not required, which I could believe (i.e. the decoder assumes an unlatch when there can't be another triplet in the stream because there's only 1-2 codewords left). However it has still got 1 character to encode and it actually <em>encodes</em> it in ASCII, but that 6th character is dropped. That itself seems like a little bug, but the right behavior is to fail the encoding, right? there isn't enough room in any encoding? That is to say I am not sure if it's an example of <em>this</em> issue.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72257039"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="7aeb9bd2e864610076af7c92ca1f1ba5">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-72257039" class="timestamp">
      <time datetime="2015-01-30T19:34:07Z" is="relative-time">Jan 30, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I think the followiing patch is the  solution:</p>

<pre><code>@@ -78,7 +78,7 @@ final class X12Encoder extends C40Encoder {
       context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
     } else if (count == 1) {
       context.pos--;
-      if (available &gt; 1) {
+      if (available != 1) {
         context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
       }
       //NOP - No unlatch necessary
</code></pre>

<p>Small explanation, if one character is left and there is exactly one codeword free than you<br>
dont have to unlatch.<br>
In all other case you have to unlatch because there is enough room left or adding a codeword will result in a bigger symbol info.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72261714"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="12f4649cb9af50f59ba0ad0352408aa9">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-72261714" class="timestamp">
      <time datetime="2015-01-30T20:03:26Z" is="relative-time">Jan 30, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Hm, the previous patch only fixes that one case. If an additional character should be encoded which isn't supported by the X12 encoder than the result is garbage.<br>
I added a german umlaut <code>*DTCP01ä</code>.<br>
If an unlatch is necessary should be decided by the remaining characters in the context.</p>

<pre><code>@@ -78,11 +78,15 @@ final class X12Encoder extends C40Encoder {
       context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
     } else if (count == 1) {
       context.pos--;
-      if (available &gt; 1) {
+      if (available != 1 || context.getRemainingCharacters() &gt; 1) {
         context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
       }
       //NOP - No unlatch necessary
       context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
+    } else {
+      if (context.getRemainingCharacters() &gt; 1) {
+        context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
+      }
     }
   }
 }
</code></pre>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72270924"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="16f431f73536e8072e9b603a898bfcb1">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-72270924" class="timestamp">
      <time datetime="2015-01-30T21:11:08Z" is="relative-time">Jan 30, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I walked through the logic, and it seems OK. All but the last character are encoded as follows:</p>

<p>(X12 latch) : 238<br>
<code>*DT</code> : 9 10<br>
<code>CP0</code> : 104 141</p>

<p>There is no space left at this point within the currently smallest pattern that can fit, which holds 5 codewords. So it skips the unlatch and continues, and ends up encoding the final character in ASCII:</p>

<p><code>1</code> : 50</p>

<p>It then picks a 12x12 pattern to fit 8 codewords, and fills the remaining 2 spots with padding. So, I don't see that this is encodable in 10x10?</p>

<p>I suppose the odd thing is that with 8 codewords, there is room for a latch, then. I don't know if it is supposed to go back and fix that, but I don't think it's the issue here?</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72387234"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="dff8186ba33426dbe536a83fcae8ef28">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-72387234" class="timestamp">
      <time datetime="2015-02-01T22:09:45Z" is="relative-time">Feb 1, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>In my opinion the logic isn't OK. The method handleEOD should not only rely on the length of the current buffer. It should be based upon the remaining characters in the context object to determine how many characters are left. As far as I understand the specification the unlatch codeword can only be missed if there is only one character left for encoding before the error correction codewords are added.<br>
That's not the case here. There are two padding codewords before error correction.<br>
It looks more terrible if you try to encode data which needs an encodation switch from X12 to another one. If I try <code>*DTCP01äaaaÜÖöüß?AbCaaa</code> it results in something like this after decoding <code>*DTCP041UEXLBSY&gt;V*ISC9&gt;D4B*YMJ0X5CRWGO320,</code><br>
If I modify the source like I mentioned above the result is ok.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72390837"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="f734a9fe1d563fedff2e4e497a29b19b">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-72390837" class="timestamp">
      <time datetime="2015-02-01T23:21:36Z" is="relative-time">Feb 1, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Yes, all OK except that last part, although I think we're on to a different issue. In 12x12, it sounds like it can't omit the unlatch.</p>

<p>I think I understand the logic now. Here's what I have after tweaking the condition a little bit for IMHO a tiny bit of extra clarity:</p>

<pre><code>  @Override
  void handleEOD(EncoderContext context, StringBuilder buffer) {
    context.updateSymbolInfo();
    int available = context.getSymbolInfo().getDataCapacity() - context.getCodewordCount();
    int count = buffer.length();
    if (count == 2) {
      // Definitely going to have to encode more, in another mode, so unlatch
      context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
      // Back up 2 places
      context.pos -= 2;
      // Switch back to ASCII
      context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
    } else if (count == 1) {
      // Back up 1 place
      context.pos--;
      // If available == 0, write an unlatch since we'll definitely have to expand the
      // code capacity anyway. If available &gt;= 2, there's room for unlatch and 1 more
      // character, so unlatch. If available == 1, it depends on how much is left to encode
      // If 1, *don't* unlatch since in this case the unlatch is omitted in order to use
      // the last codeword to encode the 1 remaining. If more is remaining, unlatch, since
      // it will be necessary to expand the code capacity anyway.
      if (available == 0 || available &gt;= 2 || context.getRemainingCharacters() &gt;= 2) {
        context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
      }
      context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
    } else {
      if (context.getRemainingCharacters() &gt;= 2) {
         context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
      }
    }
  }
</code></pre>

<p>So in the last clause though, I understand why you don't unlatch with no data left to encode (I don't think this occurs though). But if you have 1 left to encode, don't you hit the same problem? If you expand the code capacity, don't unlatch, then encode the final char, you still have padding. Does this not still need the same check on <code>available</code>?</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72535068"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="2f12248ab5d26cc4f6ead095cf5a6681">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-72535068" class="timestamp">
      <time datetime="2015-02-02T20:51:23Z" is="relative-time">Feb 2, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>I never reached the last clause with getRemainingCharacters == 1. If one is left to encode it was caught by <code>if (count == 1)</code>. But you are right. If that one case occurs it should also do an unlatch.<br>
Nevertheless, I look through the logic and I think it can be written in a shorter and in my opinion clearer way:</p>

<pre><code>  void handleEOD(EncoderContext context, StringBuilder buffer, int newMode) {
    context.updateSymbolInfo();
    int available = context.getSymbolInfo().getDataCapacity() - context.getCodewordCount();
    context.pos -= buffer.length();
    if (context.getRemainingCharacters() &gt; 1 || available &lt; context.getRemainingCharacters())
      context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
    context.signalEncoderChange(newMode);
  }
</code></pre>

<p>The encode method needs a little modification which makes it also a bit cleaner (of course, in my opinion). The method <code>signalEncoderChange(newMode);</code> is now only called at one place.</p>

<pre><code>  @Override
  public void encode(EncoderContext context) {
    //step C
    int newMode = HighLevelEncoder.ASCII_ENCODATION;
    StringBuilder buffer = new StringBuilder();
    while (context.hasMoreCharacters()) {
      char c = context.getCurrentChar();
      context.pos++;

      encodeChar(c, buffer);

      int count = buffer.length();
      if ((count % 3) == 0) {
        writeNextTriplet(context, buffer);

        newMode = HighLevelEncoder.lookAheadTest(context.getMessage(), context.pos, getEncodingMode());
        if (newMode != getEncodingMode()) {
          break;
        }
      }
    }
    handleEOD(context, buffer, newMode);
  }
</code></pre>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72637410"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="4e56ade4fb21090b7812fa88c5e210fb">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-72637410" class="timestamp">
      <time datetime="2015-02-03T11:46:57Z" is="relative-time">Feb 3, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Thinking about it the other way around, the only case where you do not unlatch is where there is 1 character left and 1 codeword available, right? I think that matches the logic in both versions of the method above. I like your simpler version; is <code>context.getRemainingCharacters() != 1 || available != 1</code> an even simpler condition to latch?</p>

<p>The <code>handleEOD</code> method is overridden from the parent and that's harder to change, so I am not sure if that's as easy as this change.</p>

<p>Anyway both conditions make my little test case pass, for the <code>*DTCP01</code> case. I have it expecting the unlatch, before finally encoding the 1 and padding with 1 codeword: <code>238 9 10 104 141 254 50 129</code></p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72724596"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="2a7c1c4f5c8d2e23650ed4568c408eef">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-72724596" class="timestamp">
      <time datetime="2015-02-03T20:10:23Z" is="relative-time">Feb 3, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>It is not only an even simpler condition. It covers another condition, too. If you give a minimum size for encoding which has more codewords (f.e. 20x20) available then remaining characters than the unlatch is missing in my version.</p>

<p>In case of <code>handleEOD</code> and the call to <code>signalEncoderChange</code>: the call can also be made in the <code>encode</code> method after <code>handleEOD</code>.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  


      
  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-4b02337">
      <span class="octicon octicon-bookmark discussion-item-icon"></span>

      <img alt="@srowen" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/822522?v=3&amp;s=32" width="16" />
      <a href="/srowen" class="author" truncate="true">srowen</a>

      referenced
      this issue
      from a commit
      <a href="#ref-commit-4b02337" class="timestamp">
        <time datetime="2015-02-04T13:45:38Z" is="relative-time">Feb 4, 2015</time>
      </a>
    </div>

    <table class="timeline-commits">
      

<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="zxing/zxing:commit:4b02337709279561745d7ae2ef7ff2e9f3b1a1a6"
    data-url="/zxing/zxing/commit/4b02337709279561745d7ae2ef7ff2e9f3b1a1a6/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit"></span>
  </td>

    <td class="commit-gravatar">
      <a href="/srowen"><img alt="@srowen" class="avatar avatar-small" height="16" src="https://avatars2.githubusercontent.com/u/822522?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/srowen" class="author" rel="contributor">srowen</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/zxing/zxing/commit/4b02337709279561745d7ae2ef7ff2e9f3b1a1a6" class="message" data-pjax="true" title="Issue #300 : simplify X12 encodation at end of input stream to fix unlatch issue. HT micjahn">Issue</a> <a href="https://github.com/zxing/zxing/issues/300" class="issue-link" title="DataMatrixWriter generates wrong BitMatrix">#300</a> <a href="/zxing/zxing/commit/4b02337709279561745d7ae2ef7ff2e9f3b1a1a6" class="message" data-pjax="true" title="Issue #300 : simplify X12 encodation at end of input stream to fix unlatch issue. HT micjahn">: simplify X12 encodation at end of input stream to fix un…</a></code>

        <span class="hidden-text-expander inline">
          <a href="#" class="js-details-target">&hellip;</a>
        </span>
        <div class="commit-desc"><pre>…latch issue. HT micjahn</pre></div>

  </td>

  <td class="commit-meta">


      <code><a href="/zxing/zxing/commit/4b02337709279561745d7ae2ef7ff2e9f3b1a1a6" class="commit-id">4b02337</a></code>
  </td>
</tr>

    </table>
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-72856194"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="eda0f2e64a64e1701b09bfd1d626953f">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-72856194" class="timestamp">
      <time datetime="2015-02-04T13:46:06Z" is="relative-time">Feb 4, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>OK I pushed the minimal fix and test case. Comment if I've still missed something.</p>
      </div>
    </div>

  </div>
</div>

  </div>
  


      


  <div class="discussion-item discussion-item-closed">
    <div class="discussion-item-header" id="event-230031129">

      <span class="octicon octicon-circle-slash discussion-item-icon"></span>
      <img alt="@srowen" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/822522?v=3&amp;s=32" width="16" />
      <a href="/srowen" class="author">srowen</a>
      closed this   <a href="https://github.com/zxing/zxing/issues/300#event-230031129" class="timestamp"><time class="timestamp" datetime="2015-02-04T13:46:06Z" is="relative-time">Feb 4, 2015</time></a>
    </div>
  </div>

  <div class="closed-banner"></div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-73132306"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="ae0c64a144d33eab317b011770c4ec63">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-73132306" class="timestamp">
      <time datetime="2015-02-05T21:27:09Z" is="relative-time">Feb 5, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>The fix doesn't work for <code>*DTCP0</code>. <code>getRemainingCharacters</code> and <code>available</code> are both 0 in that case, which is <code>!= 1</code>. An unnessary unlatch is added. That alone would not be a big issue but because of <code>if (count &gt; 0)</code> the encoding isn't changed, X12 is still active. The method HighLevelEncoder.encodeHighLevel adds now an additional unlatch. That are the resulting codewords:<br>
<code>238 9 10 104 141 254 254 129</code><br>
That's my working version of the fix:</p>

<pre><code>...
         if (context.getRemainingCharacters() &gt; 1 || available &gt; 1 || context.getRemainingCharacters() != available)
            context.writeCodeword(HighLevelEncoder.X12_UNLATCH);
         if (context.getNewEncoding() &lt; 0)
            context.signalEncoderChange(HighLevelEncoder.ASCII_ENCODATION);
...
</code></pre>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-73201889"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="68a43908ad9690b2a46ee1b5604c7f9a">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-73201889" class="timestamp">
      <time datetime="2015-02-06T08:23:00Z" is="relative-time">Feb 6, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Hm, I added a test case for this though, and it shows that the result is <code>238 9 10 104 141 254 50 129</code> in this case. How did you reproduce this</p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-73301194"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="009330f933c229d3eb0c09ab8b79258a">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-73301194" class="timestamp">
      <time datetime="2015-02-06T19:51:31Z" is="relative-time">Feb 6, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <pre><code>  @Test
  public void testX12Unlatch2() {
    String visualized = encodeHighLevel("*DTCP0");
    assertEquals("238 9 10 104 141", visualized);
  }
</code></pre>

<p>result:<br>
<code>org.junit.ComparisonFailure: expected:&lt;238 9 10 104 141[]&gt; but was:&lt;238 9 10 104 141[ 254 254 129]&gt;</code></p>
      </div>
    </div>

  </div>
</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/srowen"><img alt="@srowen" class="timeline-comment-avatar" height="48" src="https://avatars1.githubusercontent.com/u/822522?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-73317322"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container owner-comment"
     data-body-version="677e1b3a76152c17fd23d81bc9208f3c">

  <div class="timeline-comment-header ">


    <span class="timeline-comment-label">Owner</span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/srowen" class="author">srowen</a>
    </strong>

    commented

    <a href="#issuecomment-73317322" class="timestamp">
      <time datetime="2015-02-06T21:38:58Z" is="relative-time">Feb 6, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Got it. I can't think of a simpler working change, so will take yours!</p>
      </div>
    </div>

  </div>
</div>

  </div>
  


      
  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-625d9b7">
      <span class="octicon octicon-bookmark discussion-item-icon"></span>

      <img alt="@srowen" class="avatar" height="16" src="https://avatars2.githubusercontent.com/u/822522?v=3&amp;s=32" width="16" />
      <a href="/srowen" class="author" truncate="true">srowen</a>

      referenced
      this issue
      from a commit
      <a href="#ref-commit-625d9b7" class="timestamp">
        <time datetime="2015-02-06T21:39:32Z" is="relative-time">Feb 6, 2015</time>
      </a>
    </div>

    <table class="timeline-commits">
      

<tr class="commit js-details-container js-socket-channel js-updatable-content"
    data-channel="zxing/zxing:commit:625d9b77d75260495df50a383aecf95dc88cb7c2"
    data-url="/zxing/zxing/commit/625d9b77d75260495df50a383aecf95dc88cb7c2/show_partial?partial=commit%2Fcondensed"
  >

  <td class="commit-icon">
      <span class="octicon octicon-git-commit"></span>
  </td>

    <td class="commit-gravatar">
      <a href="/srowen"><img alt="@srowen" class="avatar avatar-small" height="16" src="https://avatars2.githubusercontent.com/u/822522?v=3&amp;s=32" width="16" /></a>
    </td>

    <td class="commit-author">
      <strong><a href="/srowen" class="author" rel="contributor">srowen</a></strong>
    </td>

  <td class="commit-message">
      <code><a href="/zxing/zxing/commit/625d9b77d75260495df50a383aecf95dc88cb7c2" class="message" data-pjax="true" title="Additional fix for issue #300 (HT micjahn)">Additional fix for issue</a> <a href="https://github.com/zxing/zxing/issues/300" class="issue-link" title="DataMatrixWriter generates wrong BitMatrix">#300</a> <a href="/zxing/zxing/commit/625d9b77d75260495df50a383aecf95dc88cb7c2" class="message" data-pjax="true" title="Additional fix for issue #300 (HT micjahn)">(HT micjahn)</a></code>


  </td>

  <td class="commit-meta">


      <code><a href="/zxing/zxing/commit/625d9b77d75260495df50a383aecf95dc88cb7c2" class="commit-id">625d9b7</a></code>
  </td>
</tr>

    </table>
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/micjahn"><img alt="@micjahn" class="timeline-comment-avatar" height="48" src="https://avatars3.githubusercontent.com/u/3475026?v=3&amp;s=96" width="48" /></a>
    <div id="issuecomment-73383848"
     class="comment previewable-edit timeline-comment js-comment js-task-list-container "
     data-body-version="302bda1cd032416bf697165a3d176fbe">

  <div class="timeline-comment-header ">




  <div class="timeline-comment-header-text">

    <strong>
      <a href="/micjahn" class="author">micjahn</a>
    </strong>

    commented

    <a href="#issuecomment-73383848" class="timestamp">
      <time datetime="2015-02-07T21:24:25Z" is="relative-time">Feb 7, 2015</time>
    </a>
  </div>
</div>


  <div class="comment-content">

    <div class="edit-comment-hide">
      <div class="comment-body markdown-body markdown-format js-comment-body">
          <p>Look's good now.</p>
      </div>
    </div>

  </div>
</div>

  </div>



<!-- Rendered timeline since 2015-02-07 13:24:25 -->
<div id="partial-timeline-marker"
      class="js-timeline-marker js-socket-channel js-updatable-content"
      data-channel="zxing/zxing:issue:55914117"
      data-url="/zxing/zxing/issues/300/show_partial?partial=issues%2Ftimeline_marker&amp;since=1423344265"
      data-last-modified="Sat, 07 Feb 2015 21:24:25 GMT">

    <!-- </textarea> --><!-- '"` --><form accept-charset="UTF-8" action="/zxing/zxing/notifications/mark?ids=56885387" class="hidden js-timeline-marker-form" data-form-nonce="0e24cd91ca95243948aa505cd5676d915eb1405e" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /><input name="authenticity_token" type="hidden" value="koWc1DpyNout+vgTTruMeL9FYi5LMRijRc8K8Zfo/5rYwYVnzedm2658Nh3aS1as/OpKw5NFjyJvnVdW3LtJRw==" /></div>
</form></div>


        </div>

          <div class="discussion-timeline-actions">
                <div class="signed-out-comment">
	<a href="/join" class="btn btn-primary" rel="nofollow">Sign up for free</a>
	<strong>to join this conversation on GitHub</strong>.
	Already have an account?
	<a href="/login?return_to=https%3A%2F%2Fgithub.com%2Fzxing%2Fzxing%2Fissues%2F300" rel="nofollow">Sign in to comment</a>
</div>


          </div>
      </div>

    </div>
    <div class="clear"></div>
  </div>

</div>


        </div>
      </div>
      <div class="modal-backdrop"></div>
    </div>
  </div>


    </div><!-- /.wrapper -->

      <div class="container">
  <div class="site-footer" role="contentinfo">
    <ul class="site-footer-links right">
        <li><a href="https://status.github.com/" data-ga-click="Footer, go to status, text:status">Status</a></li>
      <li><a href="https://developer.github.com" data-ga-click="Footer, go to api, text:api">API</a></li>
      <li><a href="https://training.github.com" data-ga-click="Footer, go to training, text:training">Training</a></li>
      <li><a href="https://shop.github.com" data-ga-click="Footer, go to shop, text:shop">Shop</a></li>
        <li><a href="https://github.com/blog" data-ga-click="Footer, go to blog, text:blog">Blog</a></li>
        <li><a href="https://github.com/about" data-ga-click="Footer, go to about, text:about">About</a></li>
        <li><a href="https://github.com/pricing" data-ga-click="Footer, go to pricing, text:pricing">Pricing</a></li>

    </ul>

    <a href="https://github.com" aria-label="Homepage">
      <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
</a>
    <ul class="site-footer-links">
      <li>&copy; 2015 <span title="0.24988s from github-fe139-cp1-prd.iad.github.net">GitHub</span>, Inc.</li>
        <li><a href="https://github.com/site/terms" data-ga-click="Footer, go to terms, text:terms">Terms</a></li>
        <li><a href="https://github.com/site/privacy" data-ga-click="Footer, go to privacy, text:privacy">Privacy</a></li>
        <li><a href="https://github.com/security" data-ga-click="Footer, go to security, text:security">Security</a></li>
        <li><a href="https://github.com/contact" data-ga-click="Footer, go to contact, text:contact">Contact</a></li>
        <li><a href="https://help.github.com" data-ga-click="Footer, go to help, text:help">Help</a></li>
    </ul>
  </div>
</div>


    <div class="fullscreen-overlay js-fullscreen-overlay" id="fullscreen_overlay">
  <div class="fullscreen-container js-suggester-container">
    <div class="textarea-wrap">
      <textarea name="fullscreen-contents" id="fullscreen-contents" class="fullscreen-contents js-fullscreen-contents" placeholder="" aria-label=""></textarea>
      <div class="suggester-container">
        <div class="suggester fullscreen-suggester js-suggester js-navigation-container"></div>
      </div>
    </div>
  </div>
  <div class="fullscreen-sidebar">
    <a href="#" class="exit-fullscreen js-exit-fullscreen tooltipped tooltipped-w" aria-label="Exit Zen Mode">
      <span class="mega-octicon octicon-screen-normal"></span>
    </a>
    <a href="#" class="theme-switcher js-theme-switcher tooltipped tooltipped-w"
      aria-label="Switch themes">
      <span class="octicon octicon-color-mode"></span>
    </a>
  </div>
</div>



    
    

    <div id="ajax-error-message" class="flash flash-error">
      <span class="octicon octicon-alert"></span>
      <a href="#" class="octicon octicon-x flash-close js-ajax-error-dismiss" aria-label="Dismiss error"></a>
      Something went wrong with that request. Please try again.
    </div>


      <script crossorigin="anonymous" src="https://assets-cdn.github.com/assets/frameworks-2ba3b257a78c3bd28dab11d07ddc8e6b1cf5280066968cc8501b99bf58f64a63.js"></script>
      <script async="async" crossorigin="anonymous" src="https://assets-cdn.github.com/assets/github/index-dd3051b3b36fed71a99e2c164f3e1eb38a8beaf40dc272fd2807febc8bd46a7f.js"></script>
      
      
    <div class="js-stale-session-flash stale-session-flash flash flash-warn flash-banner hidden">
      <span class="octicon octicon-alert"></span>
      <span class="signed-in-tab-flash">You signed in with another tab or window. <a href="">Reload</a> to refresh your session.</span>
      <span class="signed-out-tab-flash">You signed out in another tab or window. <a href="">Reload</a> to refresh your session.</span>
    </div>
  </body>
</html>

